@model OtherClasses.Models.MR_DATA.MR_DATAvm

@{
    ViewBag.Title = "FamilyMembersGroupings";
    ViewBag.TitleBar = "FAMILY GROUPING";
    Layout = "~/Views/Shared/_MRFormLayout.cshtml";
}

<style>
    .bgColor {
        background-color: #02c7e5;
    }

    .tableDiv {
        height: 25rem;
    }
</style>


<!--Modal Start-->
<div id="1LkUp" class="djq-modal djq-hide">

    <div class="djq-body">
        <div>
            <div class="djq-body1 deep-g alc">
                <label class="label ls">LOOKUP FOR REGISTERED PATIENTS</label>
            </div>
            <div class="numberOfRows djq-hide"></div>

            <div class="djq-body11 alc">
                <label class="label">Search: </label>
                <input type="text" id="mySearchTerm" value="" class="input w-7" />
                <button type="button" id="btnSearch" class="btn clm search-dataJQ">SEARCH</button>
                <label id="djq-result" class="label"></label>
                <label id="djq-aval" class="label hide">LOADING...</label>
                <label id="djq-curVal" class="djq-hide"></label>
                <label id="djq-max" class="djq-hide"></label>
            </div>
            <div class="loader djq-transp">.</div>

        </div>
        <div>
            <div class="djq-body2" style="margin-top: 0px !important;">
                <table id="regPTable1">

                    <thead>
                    </thead>
                    <tbody></tbody>

                </table>
            </div>
        </div>

        <div class="djq-body3 deep-g alc">
            <div class="inline-block ww50 all va-top">
                <button type="button" id="first"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &lt;&lt;&lt;
                </button>
                <button type="button" id="previous"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &lt;&lt;
                </button>
                <button type="button" id="next"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &gt;&gt;
                </button>
                <button type="button" id="last"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &gt;&gt;&gt;
                </button>
            </div>
            <div class="inline-block ww45 va-top">
                <button type="button" class="btn clm select-dataJQ">SELECT</button>
                <button type="button" class="btn clm close-dataJQ">CLOSE</button>
            </div>
        </div>
    </div>
</div>
<!--Modal End-->

<!--Modal Start-->
<div id="2LkUp" class="djq-modal djq-hide">

    <div class="djq-body">
        <div>
            <div class="djq-body1 deep-g alc">
                <label class="label ls">LOOKUP FOR REGISTERED PATIENTS</label>
            </div>
            <div class="numberOfRows djq-hide"></div>

            <div class="djq-body11 alc">
                <label class="label">Search: </label>
                <input type="text" id="mySearchTerm" value="" class="input w-7" />
                <button type="button" id="btnSearch" class="btn clm search-dataJQ">SEARCH</button>
                <label id="djq-result" class="label"></label>
                <label id="djq-aval" class="label hide">LOADING...</label>
                <label id="djq-curVal" class="djq-hide"></label>
                <label id="djq-max" class="djq-hide"></label>
            </div>
            <div class="loader djq-transp">.</div>

        </div>
        <div>
            <div class="djq-body2" style="margin-top: 0px !important;">
                <table id="regPTable2">

                    <thead>
                    </thead>
                    <tbody></tbody>

                </table>
            </div>
        </div>

        <div class="djq-body3 deep-g alc">
            <div class="inline-block ww50 all va-top">
                <button type="button" id="first"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &lt;&lt;&lt;
                </button>
                <button type="button" id="previous"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &lt;&lt;
                </button>
                <button type="button" id="next"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &gt;&gt;
                </button>
                <button type="button" id="last"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &gt;&gt;&gt;
                </button>
            </div>
            <div class="inline-block ww45 va-top">
                <button type="button" class="btn clm select-dataJQ">SELECT</button>
                <button type="button" class="btn clm close-dataJQ">CLOSE</button>
            </div>
        </div>
    </div>
</div>
<!--Modal End-->

<!--Modal Start-->
<div id="3LkUp" class="djq-modal djq-hide">

    <div class="djq-body">
        <div>
            <div class="djq-body1 deep-g alc">
                <label class="label ls">LOOKUP FOR REGISTERED PATIENTS</label>
            </div>
            <div class="numberOfRows djq-hide"></div>

            <div class="djq-body11 alc">
                <label class="label">Search: </label>
                <input type="text" id="mySearchTerm" value="" class="input w-7" />
                <button type="button" id="btnSearch" class="btn clm search-dataJQ">SEARCH</button>
                <label id="djq-result" class="label"></label>
                <label id="djq-aval" class="label hide">LOADING...</label>
                <label id="djq-curVal" class="djq-hide"></label>
                <label id="djq-max" class="djq-hide"></label>
            </div>
            <div class="loader djq-transp">.</div>

        </div>
        <div>
            <div class="djq-body2" style="margin-top: 0px !important;">
                <table id="regPTable3">

                    <thead>
                    </thead>
                    <tbody></tbody>

                </table>
            </div>
        </div>

        <div class="djq-body3 deep-g alc">
            <div class="inline-block ww50 all va-top">
                <button type="button" id="first"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &lt;&lt;&lt;
                </button>
                <button type="button" id="previous"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &lt;&lt;
                </button>
                <button type="button" id="next"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &gt;&gt;
                </button>
                <button type="button" id="last"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &gt;&gt;&gt;
                </button>
            </div>
            <div class="inline-block ww45 va-top">
                <button type="button" class="btn clm select-dataJQ">SELECT</button>
                <button type="button" class="btn clm close-dataJQ">CLOSE</button>
            </div>
        </div>
    </div>
</div>
<!--Modal End-->

<!--Modal Start-->
<div id="4LkUp" class="djq-modal djq-hide">

    <div class="djq-body">
        <div>
            <div class="djq-body1 deep-g alc">
                <label class="label ls">LOOKUP FOR REGISTERED PATIENTS</label>
            </div>
            <div class="numberOfRows djq-hide"></div>

            <div class="djq-body11 alc">
                <label class="label">Search: </label>
                <input type="text" id="mySearchTerm" value="" class="input w-7" />
                <button type="button" id="btnSearch" class="btn clm search-dataJQ">SEARCH</button>
                <label id="djq-result" class="label"></label>
                <label id="djq-aval" class="label hide">LOADING...</label>
                <label id="djq-curVal" class="djq-hide"></label>
                <label id="djq-max" class="djq-hide"></label>
            </div>
            <div class="loader djq-transp">.</div>

        </div>
        <div>
            <div class="djq-body2" style="margin-top: 0px !important;">
                <table id="regPTable4">

                    <thead>
                    </thead>
                    <tbody></tbody>

                </table>
            </div>
        </div>

        <div class="djq-body3 deep-g alc">
            <div class="inline-block ww50 all va-top">
                <button type="button" id="first"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &lt;&lt;&lt;
                </button>
                <button type="button" id="previous"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &lt;&lt;
                </button>
                <button type="button" id="next"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &gt;&gt;
                </button>
                <button type="button" id="last"
                        class="btn clm " style="background-color:#607d8b !important;">
                    &gt;&gt;&gt;
                </button>
            </div>
            <div class="inline-block ww45 va-top">
                <button type="button" class="btn clm select-dataJQ">SELECT</button>
                <button type="button" class="btn clm close-dataJQ">CLOSE</button>
            </div>
        </div>
    </div>
</div>
<!--Modal End-->


<section>
    <form method="post" action="@Url.Action("FamilyMemberSubmit", "File")">
        @Html.AntiForgeryToken()
        
        <section class="pb-5 bgColor">
            <div class="pt-1 pb-4 drk size la3">FAMILY HEAD DETAILS:</div>
           
            <div class="row my-2">
                <div class="col-md-5">
                    <div class="mb-2">
                        <label class="label w-3 w-35 drk">GROUP CODE</label>
                        <input type="text" name="REPORTS.txtgroupcode" value="" class="input w-4 w-50 cData1 groupCode" />
                        <input type="button" id="refLookUp1" class="btn-small" />
                    </div>
                    <div>
                        <label class="label w-3 w-35 drk">PATIENT NO</label>
                        <input type="text" name="REPORTS.txtpatientno" value="" class="input w-4 w-50 dData1 cData2 patientNo" />
                        <input type="button" id="refLookUp2" class="btn-small" />
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="mb-3">
                        <label class="label w-4 w-35 drk">TOTAL IN GROUP:</label>
                        <input type="number" value="" class="input w-4 w-50 totalInGroup" />
                    </div>
                    <div>
                        <label class="label w-4 w-35 drk">FULL NAME</label>
                        <input type="text" name="REPORTS.TXTPATIENTNAME" value="" class="input w-10 w-50 fullName" />
                    </div>
                </div>
            </div>
        </section>

        <section>
            <div class="drk size la3">MEMBERS:</div>
            <div class="row py-4">
                <div class="col-md-5">
                    <div class="mb-2">
                        <label class="label w-5 w-35 drk">Patient's Group Code</label>
                        <input type="text" name="REPORTS.txtgroupcode" value="" class="input w-4 w-50 mb-2 eData1 patientGroupCode" />
                        <input type="button" id="refLookUp3" class="btn-small" />
                    </div>
                    <div class="">
                        <label class="label w-5 w-35 drk">Hospital No.</label>
                        <input type="text" name="REPORTS.txtpatientno" value="" class="input w-4 w-50 fData1 eData2 hospitalNo" />
                        <input type="button" id="refLookUp4" class="btn-small" />
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="">
                        <label class="label w-4 w-35 drk">Patient's Name</label>
                        <input type="text" name="REPORTS.txtothername" value="" class="input w-10 w-50 patientName" />
                    </div>
                </div>
            </div>
        </section>

        <section>
            <div class="row d-flex justify-content-center my-3">
                <input type="button" value="ADD" class="btn addBtn" />
            </div>
        </section>

        <section>
            <div class="tableDiv v-scroll">
                <table class="" name="REPORTS.RptPath">
                    <thead>
                        <tr>
                            <th>S/N</th>
                            <th>NAME</th>
                            <th>GROUPCODE</th>
                            <th>PATIENTNO</th>
                            <th>ADDRESS</th>
                            <th>SEX</th>
                            <th>D.OF.BIRTH</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody class="tbody1">
                    </tbody>
                </table>
            </div>
        </section>

        <section>
            <div class="row my-4 d-flex justify-content-around">
                <span>
                    <input type="checkbox" id="trans" class="chkMoveTransactions"/>
                    <label for="trans" class="label drk">Move all Previous Transactions</label>
                </span>
                
                <span>
                    <input type="checkbox" id="group" />
                    <label for="group" class="label drk">Re-Group</label>
                </span>
            </div>
        </section>

        <section>
            <div class="row d-flex justify-content-around my-3">
                <span>
                    <input type="button" value="SUBMIT" class="btn submitBtn" />
                    <input type="submit" value="SUBMIT" class="btn hiddenSubmitBtn" />
                </span>            
                <span>
                    <a href="~/Home/Index" title="Close"><input type="button" name="" value="Close" class="btn oraa" /></a>
                </span>
            </div>
        </section>

    </form>

</section>


@section scripts
{
    <script>
        $(function () {
            var dOM = $('body'); //must assign
            var formFields = document.getElementById('mainForm'); //must assign, used for calling javaScript methods
            appendTagInvalid1(dOM, "@ViewBag.iinvalid"); //must call
            servErrorAlert("#eLkUp", "@ViewBag.Msg"); //must call

            var dTHN1 = ['NAME', 'GROUPCODE', 'PATIENTNO', 'RESIDENCE', 'GROUPHEAD', 'SEX', 'PHONE']; //for table header
            var dBCN1 = ['NAME', 'GROUPCODE', 'PATIENTNO', 'RESIDENCE', 'GROUPHEAD', 'SEX', 'PHONE']; //for database header
            var jaxURL1 = "@Url.Action("RptBillChainLookUp", "AJAX")";

            //For group code
            LoadDynamicDT1(jaxURL1, dTHN1, dBCN1, 'BILLCHAINS', '#refLookUp1', '#1LkUp', '#regPTable1', '.cData', [3, 4]);

            //For Patient No.
            LoadDynamicDT1(jaxURL1, dTHN1, dBCN1, 'BILLCHAINS', '#refLookUp2', '#2LkUp', '#regPTable2', '.dData', [4]);

            //For Patient GroupCode
            LoadDynamicDT1(jaxURL1, dTHN1, dBCN1, 'BILLCHAINS', '#refLookUp3', '#3LkUp', '#regPTable3', '.eData', [3, 4]);

            //For Hospital No.
            LoadDynamicDT1(jaxURL1, dTHN1, dBCN1, 'BILLCHAINS', '#refLookUp4', '#4LkUp', '#regPTable4', '.fData', [4]);


            //on Page Load
            $(".groupCode").focus();
            $(".hiddenSubmitBtn").hide();

            //Refresh Page
            function ClearControls() {
                location.reload(true);
                scrollToTop();
            }
            
            $(".groupCode").on({
                focusout: function () {
                    if ($(this).val().trim() != "") {
                        $(".patientNo").focus();
                    }
                }
            })

            $(".patientNo").on({
                focusout: function () {
                    let patientNo = $(this).val();
                    let groupCode = $(".groupCode").val();

                    if ($(this).val().trim() != "") {

                        $.ajax({
                            url: "/AJAX/FamMembPatientFocusOut",
                            method: "POST",
                            data: { patientNo: patientNo, groupCode: groupCode },
                            success: function (data) {

                                if(data.REPORTS.alertMessage != null){
                                    alert(data.REPORTS.alertMessage);

                                    $(".patientNo").val("");
                                    $(".patientNo").focus();
                                }
                                else
                                {
                                    if (data.REPORTS.TXTPATIENTNAME != null) {
                                        $(".fullName").val(data.REPORTS.TXTPATIENTNAME)
                                    }

                                    if (data.BILLCHAINS != null) {
                                        let billChainList = data.BILLCHAINS;

                                        $(".totalInGroup").val(billChainList.length);

                                        let count = 0;
                                        let rows = "";
                                        for (i = 0; i < billChainList.length; i++) {
                                            let birthDate = billChainList[i].BIRTHDATE
                                           
                                            count++;

                                            rows += "<tr>" +
                                                        "<td>" + count + "</td>" +
                                                        "<td>" + billChainList[i].NAME + "</td>" +
                                                        "<td>" + billChainList[i].GROUPCODE + "</td>" +
                                                        "<td>" + billChainList[i].PATIENTNO + "</td>" +
                                                        "<td>" + billChainList[i].RESIDENCE + "</td>" +
                                                        "<td>" + billChainList[i].SEX + "</td>" +
                                                        "<td>" + formatDate1(birthDate) + "</td>" +
                                                        "<td>" + "" + "</td>" +
                                                    "</tr>";
                                        }

                                        $(".tbody1").html(rows);
                                    }

                                }
                            }
                        })

                    }
                }
            })

            $(".patientGroupCode").on({
                focusout: function () {
                    if ($(this).val().trim() != "") {
                        $(".hospitalNo").focus();
                    }
                }
            })

            $(".hospitalNo").on({
                focusout: function () {
                    let patientGroupCode = $(".patientGroupCode").val();
                    let hospitalNo = $(".hospitalNo").val();
                    
                    if (patientGroupCode.trim() != "") {
                        $.ajax({
                            url: "/AJAX/FamMemHospitalNoFocusOut",
                            method: "POST",
                            data: { patientGroupCode: patientGroupCode, hospitalNo: hospitalNo },
                            success: function (data) {
                                
                                if(data.REPORTS.alertMessage != null)
                                {
                                    alert(data.REPORTS.alertMessage)
                                }

                                if (data.REPORTS.txtothername != null)
                                {
                                    $(".patientName").val(data.REPORTS.txtothername)
                                }

                            }
                        })

                    }
                }
            })

            $(".addBtn").on({
                click: function () {

                    let patientNo = $(".patientNo").val();
                    let groupCode = $(".groupCode").val();
                    let hospitalNo = $(".hospitalNo").val();
                    let patientGroupCode = $(".patientGroupCode").val();
                    let patientName = $(".patientName").val();
                    let fullName = $(".fullName").val();

                    if (patientNo.trim() == "") {
                        alert("Patient No is Required");
                        $(".patientNo").focus();
                    } else if (groupCode.trim() == "") {
                        alert("GroupCode is Required");
                        $(".groupCode").focus();
                    } else if (hospitalNo.trim() == "") {
                        alert("Hospital No is Required");
                        $(".hospitalNo").focus();
                    } else if (patientGroupCode.trim() == "") {
                        alert("Patient GroupCode is Required");
                        $(".patientGroupCode").focus();
                    } else if (patientName.trim() == "") {
                        alert("Patient Name is Required");
                        $(".patientName").focus();
                    } else if (fullName.trim() == "") {
                        alert("Full Name is Required");
                        $(".fullName").focus();
                    } else {

                        let totalRows = Number( $(".tbody1").find("tr").last().find("td").eq(0).text() );

                        let flag = false;

                        for (let i = 0; i < totalRows; i++)
                        {
                            let tableGroupCode = $(".tbody1").find("tr").eq(i).find("td").eq(2).text();
                            let tablePatientNo = $(".tbody1").find("tr").eq(i).find("td").eq(3).text();

                            if (tableGroupCode.trim() == patientGroupCode.trim() && tablePatientNo.trim() == hospitalNo.trim())
                            {
                                flag = true;
                                break;
                            }
                        }

                        if (flag == true)
                        {
                            alert("This Patient is already a Member of this Family...");
                        }
                        else {

                            $.ajax({
                                url: "/AJAX/AddBtnClicked",
                                method: "POST",
                                data: { patientGroupCode: patientGroupCode, hospitalNo: hospitalNo },
                                success: function (data) {

                                    let num = $(".tbody1").find("tr").last().find("td").eq(0).text();
                                    let count = Number(num) + 1;

                                    let birthDate = data.BILLCHAIN.BIRTHDATE;
                                   
                                    let rows = "<tr>" +
                                                    "<td>" + count + "</td>" +
                                                    "<td>" + data.BILLCHAIN.NAME + "</td>" +
                                                    "<td>" + data.BILLCHAIN.GROUPCODE + "</td>" +
                                                    "<td>" + data.BILLCHAIN.PATIENTNO + "</td>" +
                                                    "<td>" + data.BILLCHAIN.RESIDENCE + "</td>" +
                                                    "<td>" + data.BILLCHAIN.SEX + "</td>" +
                                                    "<td>" + formatDate1(birthDate) + "</td>" +
                                                    "<td>" + data.BILLCHAIN.STATUS + "</td>" +
                                                "</tr>";

                                    $(".tbody1").append(rows);

                                }
                            })

                        }

                        $(".submit").prop({ disabled: false });

                    }




                }
            })

            $(".submitBtn").on({
                click: function () {
                    let patientNo = $(".patientNo").val();
                    let groupCode = $(".groupCode").val();
                    let tbody = $(".tbody1").text();
                    let chkMoveTransactions = $(".chkMoveTransactions").prop("checked");

                    if (patientNo.trim() == "") {
                        alert("Patient No is Required!!");
                        $(".patientNo").focus();
                    } else if (groupCode.trim() == "") {
                        alert("GroupCode is Required!!");
                        $(".groupCode").focus();
                    } else if (tbody.trim() == "") {
                        alert("The Table is Empty!!");
                    } else {
                        if (confirm("Confirm to Save...")) {
                            let tableList = [];

                            $(".tbody1").find("tr").each(function () {
                                let rowObject = {
                                    NAME: $(this).find("td").eq(1).text(),
                                    GROUPCODE: $(this).find("td").eq(2).text(),
                                    PATIENTNO: $(this).find("td").eq(3).text(),
                                    ADDRESS: $(this).find("td").eq(4).text(),
                                    SEX: $(this).find("td").eq(5).text(),
                                    BIRTHDATE: $(this).find("td").eq(6).text(),
                                    STATUS: $(this).find("td").eq(7).text().trim()
                                };

                                tableList.push(rowObject)
                            });

                            $.ajax({
                                url: "/AJAX/FamGroupOnSubmit",
                                method: "POST",
                                data: { tableList: tableList, patientNo: patientNo, groupCode: groupCode, chkMoveTransactions: chkMoveTransactions },
                                success: function (data) {
                                    if (data.REPORTS.alertMessage != null) {
                                        alert(data.REPORTS.alertMessage)
                                    }

                                    if (data.REPORTS.txtgroupcode != null && data.REPORTS.txtpatientno != null) {
                                        $(".tbody1").find("tr").each(function () {
                                            let groupCode = $(this).find("td").eq(2).text().trim();
                                            let patientNo = $(this).find("td").eq(3).text().trim();
                                            let dataGroupCode = data.REPORTS.txtgroupcode.trim();
                                            let dataPatientNo = data.REPORTS.txtpatientno.trim();

                                            if(groupCode == dataGroupCode && patientNo == dataPatientNo)
                                            {
                                                $(this).find("td").eq(7).text("");
                                            }

                                        });

                                    }

                                }
                            })

                        } else {
                            return;
                        }
                    }

                }
            })


            function formatDate1(str) {
                str = Number(str.slice(str.indexOf("(") + 1, str.indexOf(")")));
                var d = new Date(str);
                d = ('0' + d.getDate()).slice(-2) + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + d.getFullYear();
                return d;//returns 01-01-1970
            };

        })
    </script>
}